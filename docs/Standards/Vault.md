# Vault

## Rules

*   Vault data should be stored in a flat file (single encrypted vault), there can be multiple files in each host and group.
*   Vault files should only be stored within the environment directory and nowhere else.
*   Vault files should never be decrypted to edit, use the CLI edit commands
    *   This is to avoid accidentally committing access credentials to Git
*   See the [best practice page](https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html#variables-and-vaults) for more information


### Variables

All vault variables should be prefixed with “vault_” and then loaded directly into vars files.

The files that load the vault variables can be group specific (e.g. - vars/mysql.yml, vars/nginx.yml).

All vault files should be placed into the environment directory and be encrypted using the Ansible vault commands.


### CI and Vault Data

It is essential that all vault data is kept in an encrypted state when being pushed to Git.
This should be enforced by both the [pre-commit hook](./QA-CI.md#pre-commit-hook-client) and post-receive hooks.

### Generating Passwords and Vaulted Variables

Suggest a standardised approach to generating passwords etc and adding them to the vault - eg something like these scripts:

For development environments, as much as possible passwords should not be vaulted but created on the fly using the lookup [password module](https://docs.ansible.com/ansible/latest/plugins/lookup/password.html). These should be saved into the environment directory where they will be git ignored by default. This can be used for things like MySql database password that are only used within the environment. 

They should use the variable name as the filename that they will be saved to.

An example of this would be as follows:


```
magento2_admin_password: >-
  "{{
  lookup('password',
  '{{ inventory_dir }}/one-time-passwords/magento2-admin-password
  length=32
  chars=ascii_letters,digits')
  }}"
```



### Secret

Using vault password file - not tracked by git, store the password in a secure location eg info sharing project.

The vault secret can be generated by any decent password generator.

[Diceware](https://www.rempe.us/diceware/#eff) is a popular one to use.

### Command Line

Ansible provides the ansible-vault command to work with encrypted data.

The command allows viewing and editing the encrypted data.

The Vault command provides all the necessary functionality to work with encrypted data providing you have the vault secret in place correctly.


#### Command List



*   create
*   Decrypt
    *   Do not use this, use edit/view
    *   Can potentially allow unencrypted data to be committed
*   edit
*   view
*   encrypt
*   encrypt_string
*   rekey

Refer to the [official documentation](https://docs.ansible.com/ansible/latest/cli/ansible-vault.html) for more information


